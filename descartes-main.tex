% [[- LaTeX prelude
\documentclass[12pt,letterpaper]{book}

\usepackage[no-math]{fontspec}
\setmainfont{Baskerville}

\usepackage[nolocalmarks]{polyglossia}
\setdefaultlanguage{english}
\setotherlanguage[variant=medieval]{latin}
\setotherlanguage[variant=ancient]{greek}
\newfontfamily\greekfont[Script=Greek]{Times New Roman}
\uccode`\u=`\U

\usepackage{emptypage}
\usepackage{etoolbox}
\usepackage{marginnote}
\makeatletter
\patchcmd{\@mn@margintest}{\@tempswafalse}{\@tempswatrue}{}{}
\patchcmd{\@mn@margintest}{\@tempswafalse}{\@tempswatrue}{}{}
\reversemarginpar
\makeatother

\usepackage{csquotes}
\usepackage[style=authoryear,backend=biber,dashed=false,%	
	abbreviate=false,maxnames=4]{biblatex}
\addbibresource{descartes.bib}
% See the following resources:
%   https://orthostat.wordpress.com/2013/02/16/moving-to-biblatex-1/
%%
% Remove pp. in citations.
\DeclareFieldFormat{postnote}{#1}
% Remove pp. from bibliography.
\DeclareFieldFormat%
    [article,inbook,incollection,inproceedings,thesis,patent,unpublished]%
    {pages}{{\nopp#1}}
% Use single quotes around titles of chapters and articles, not double.
% \DeclareFieldFormat%
%     [article,inbook,incollection,inproceedings,thesis,patent,unpublished]%
%     {title}{`#1'}
% Use commas rather than periods to separate units in the bibliography.
% \renewcommand*{\newunitpunct}{\addcomma\space}
% Place a space rather than a comma between name and year in citations.
% \renewcommand{\nameyeardelim}{~}
% Place a colon+narrow space before page numbers in citations.
\renewcommand{\postnotedelim}{:\,}
% No "in:" for articles at all. For all else, remove the colon.
\renewbibmacro{in:}{%
	\ifentrytype{article}{}{\printtext{\bibstring{in}}}
}
% Remove parentheses around date in bibliography.
% See http://tex.stackexchange.com/a/40710/29387
\usepackage{xpatch}
\xpatchbibmacro{date+extrayear}{%
	\printtext[parens]%
}{%
	\setunit{\addperiod\space}%
	\printtext%
}{}{}

\usepackage{enumitem}
\setlist{noitemsep}
\usepackage[super]{nth}
\usepackage[linktoc=all]{hyperref}

\usepackage[noend,nofamiliar,noledgroup,series={A}]{reledmac}
\Xlemmaseparator[A]{:}

% Insert AT numbers and a marker for where the division occurs
\newcommand{\at}[1]{%
    |\ledsidenote{{#1}}%
}

% Wrapper for textual notes. Use as follows:
% \var{word or phrase}{comment}
\newcommand{\var}[2]{%
    {#1}\footnote{{#1} : {#2}}%
}
% Second wrapper for textual variants. Use as follows:
% \vvar{word or phrase}{source}{alternative}{source}
\newcommand{\vvar}[4]{%
    {#1}\footnote{{#1} \textbf{{#2}} : {#3} \textbf{{#4}}}%
}
% A wrapper for introducing new items into the commentary
\newcommand{\lemc}[1]{\textbf{{#1}:}}
\newcommand{\lem}[1]{\textbf{{#1}}}

% Hackish way to make abbreviations look the way I want them to
\newcommand{\abbrlabel}[1]{\makebox[3cm][l]{\textbf{#1}}}
\newenvironment{abbreviations}{%
    \begin{list}{}{\renewcommand{\makelabel}{\abbrlabel}%
    \setlength{\labelwidth}{3cm}\setlength{\leftmargin}{\labelwidth+\labelsep}%
    \setlength{\itemsep}{0pt}}}{\end{list}%
}

% Clear space under a chunk of text before printing notes.
\newcommand{\prenotes}{%
    \bigskip
    \bigskip
    \footnoterule
    \bigskip
}

\begin{hyphenrules}{latin}
    \hyphenation{pro-inde su-per-ex-tru-xi}
\end{hyphenrules}

\begin{hyphenrules}{english}
    \hyphenation{Des-cartes pos-sent}
\end{hyphenrules}

\raggedbottom

%\pagestyle{plain}
\addtocontents{toc}{\setcounter{tocdepth}{0}}
\renewcommand\thesection{}
\renewcommand\thesubsection{}
\makeatletter
\def\@seccntformat#1{\csname #1ignore\expandafter\endcsname\csname the#1\endcsname\quad}
\let\sectionignore\@gobbletwo
\let\latex@numberline\numberline
\def\numberline#1{\if\relax#1\relax\else\latex@numberline{#1}\fi}
\makeatother

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\fancyhead[RO, LE]{\thepage}
\fancyhead[CE]{\MakeUppercase{\leftmark}}
\fancyhead[CO]{\MakeUppercase{\rightmark}}
\renewcommand{\chaptermark}[1]{\markboth{{\textenglish{#1}}}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}{}}
% -]] Latex prelude

% [[- Document
\begin{document}

\nocite{*}

\include{descartes-titlepage}

\frontmatter
    \include{descartes-toc}
    \include{descartes-abbreviations}

\mainmatter
    \include{descartes-introduction}
    \include{meditatio-prima}
    \include{meditatio-secunda}
    %\include{descartes-background}
    \include{descartes-vocabulary}

\backmatter
    \markboth{Bibliography}{Bibliography}
    \printbibliography

\end{document}
% -]] Document
