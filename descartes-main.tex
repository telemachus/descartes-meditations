% [[- LaTeX prelude
\documentclass[12pt,letterpaper,oneside]{mybook}
\usepackage[no-math]{fontspec}
\usepackage{textcomp}
% Comment out the two lines below and uncomment the next line if you don't
% have Gentium Basic and Gentium Plus fonts.
\setmainfont[Renderer=ICU,Mapping=tex-text,BoldFont={Gentium Basic Bold}]%
    {Gentium Plus}
%\setmainfont{Baskerville}
\usepackage[en]{metre}
\newcommand\spaced[1]{%
    {\addfontfeature{LetterSpace=18}{#1}}
}
%\usepackage{moredefs,lips}
\usepackage[noreledmac]{eledmac}
\linenumincrement{5}
\linenummargin{right}
\lemmaseparator{:}
\footparagraph{A}
\beforeXnotes[A]{1.5em}
\afterXrule[A]{.5em}
\usepackage{etoolbox}

\newcommand{\chapterTitle}{}
\newcommand{\sectionTitle}{}
\newcommand{\subsubsectionTitle}{}
\makeatletter
\renewcommand\contentsname{Contents}
\let\oldChapter\chapter
\renewcommand*\chapter{%
    \@ifstar{\starchapter}{\@dblarg\nostarchapter}
}
\newcommand*\starchapter[1]{%
    \oldChapter*{{#1}}%
    \if@mainmatter%
        \renewcommand{\chapterTitle}{{#1}}%
        \addcontentsline{toc}{chapter}{{#1}}%
    \fi
}
\def\nostarchapter[#1]#2{\oldChapter[{#1}]{{#2}}}

\let\oldSection\section
\renewcommand*\section{%
    \@ifstar{\starsection}{\@dblarg\nostarsection}
}
\newcommand*\starsection[1]{%
    \oldSection*{{#1}}%
    \if@mainmatter%
        \renewcommand{\sectionTitle}{{#1}}%
        \addcontentsline{toc}{section}{{#1}}%
    \fi
}
\def\nostarsection[#1]#2{\oldSection[{#1}]{{#2}}}

\let\oldSubsubsection\subsubsection
\renewcommand*\subsubsection{%
    \@ifstar{\starsubsubsection}{\@dblarg\nostarsubsubsection}
}
\newcommand*\starsubsubsection[1]{%
    \oldSubsubsection*{{#1}}%
    \if@mainmatter%
        \renewcommand{\subsubsectionTitle}{{#1}}%
    \fi
}
\def\nostarsubsubsection[#1]#2{\oldSubsubsection[{#1}]{{#2}}}
\makeatother

% A wrapper for textual variants
\newcommand{\var}[3]{%
    \edtext{{#1}}{\Afootnote{{#2} \textbf{{#3}}}}%
}
\newcommand{\vvar}[4]{%
    \edtext{{#1}}{\lemma{{#1} \textbf{{#2}}}\Afootnote{{#3} \textbf{{#4}}}}%
}
% A wrapper for introducing new items into the commentary
\newcommand{\lem}[1]{\textbf{{#1}}}
\renewcommand\thesubsection{\arabic{subsection}}
\setcounter{secnumdepth}{1}
\usepackage{extramarks}
\newcommand{\comment}[2]{%
    \edef\tempa{#1}\edef\tempb{#2}%
    \subsubsection{{#1}\ifx\tempa\tempb\relax\else--{#2}\fi}
    \markright{#1}
}
\newcommand{\chapHeader}{%
    {\chapterTitle}: {\sectionTitle}%
}
\newcommand{\comHeader}{%
    \edef\tempa{\rightmark}\edef\tempb{\lastrightmark}%
    {\MakeUppercase{{\chapterTitle}: {\sectionTitle} {\subsubsectionTitle}}}%
        \rightmark\ifx\tempa\tempb\relax\else--\lastrightmark\fi
}
\renewcommand{\mymarks}{%
    \expandafter\ifstrequal\chapterTitle{Commentary}%
        {\comHeader}%
        {\MakeUppercase{\chapHeader}}%
}

% Hackish way to make abbreviations look the way I want them to
\newcommand{\abbrlabel}[1]{\makebox[3cm][l]{\textbf{#1}}}
\newenvironment{abbreviations}{%
    \begin{list}{}{\renewcommand{\makelabel}{\abbrlabel}%
    \setlength{\labelwidth}{3cm}\setlength{\leftmargin}{\labelwidth+\labelsep}%
    \setlength{\itemsep}{0pt}}}{\end{list}}

\usepackage{natbib}
\usepackage{bibentry}
\nobibliography*
\renewcommand{\bibsection}{\chapter{Bibliography}}
\bibpunct{(}{)}{;}{a}{,}{,}
\usepackage{enumitem}
\setlist{noitemsep}
\usepackage{calc}
\usepackage[super]{nth}
\usepackage[linktoc=all]{hyperref}
\pagestyle{myheadings}

\newcommand\at[1]{\-\marginpar[\raggedleft\scriptsize #1]%
    {\raggedright\scriptsize #1}%
}

\hyphenation{super-ae-di-fi-ca-tum co-lo-ri-bus}
% -]]

% [[- Document-
\begin{document}

\nocite{*}

\include{descartes-titlepage}

\frontmatter
    \include{descartes-toc}
    \include{descartes-abbreviations}

\mainmatter
    \pagenumbering{arabic}
    \include{descartes-introduction}
    \include{descartes-text}
    \include{descartes-commentary}
    \include{descartes-vocabulary}

\backmatter
    \bibliographystyle{apa}
    \bibliography{descartes}

\end{document}
% -]]
